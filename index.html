<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>金融小遊戲整合</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --primary:#1d4ed8; --primary2:#2563eb;
      --danger:#b91c1c; --success:#047857;
      --shadow:0 10px 30px rgba(15,23,42,.10);
      --shadow2:0 6px 20px rgba(15,23,42,.08);
      --radius:14px; --radius2:10px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af;
      --border:#22304a; --primary:#60a5fa; --primary2:#93c5fd;
      --danger:#f87171; --success:#34d399;
      --shadow:0 12px 36px rgba(0,0,0,.35);
      --shadow2:0 8px 24px rgba(0,0,0,.28);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text); line-height:1.45;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(135deg, var(--primary), #0b3aa8);
      color:#fff; padding:14px 18px; box-shadow:var(--shadow2);
    }
    [data-theme="dark"] header{ background:linear-gradient(135deg, #0b3aa8, #072a74); }
    header .wrap{
      max-width:1120px; margin:0 auto; display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; justify-content:space-between;
    }
    header h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    header p{ margin:0; font-size:12px; opacity:.9; }
    .header-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .container{ max-width:1120px; margin:16px auto 48px; padding:0 16px; }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0; }
    .tab-btn{
      border:1px solid rgba(255,255,255,0); padding:10px 14px; border-radius:999px;
      background:var(--border); color:var(--text); cursor:pointer; font-size:14px;
      transition:transform .06s ease, background .15s ease, color .15s ease;
      user-select:none;
    }
    [data-theme="dark"] .tab-btn{ background:#18233a; border-color:#22304a; }
    .tab-btn:hover{ transform:translateY(-1px); }
    .tab-btn.active{
      background:#0b3aa8; color:#fff; box-shadow:0 8px 20px rgba(29,78,216,.25);
    }

    .card{
      background:var(--card); border:1px solid rgba(229,231,235,.7);
      border-radius:var(--radius); padding:16px; box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    [data-theme="dark"] .card{ border-color:rgba(34,48,74,.9); }

    .card-header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:8px;
    }
    h2{ margin:0; font-size:18px; letter-spacing:.2px; }
    h3{ margin:16px 0 8px; font-size:14px; letter-spacing:.1px; }
    .small{ font-size:12px; color:var(--muted); margin:6px 0 0; }

    .pill{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:rgba(37,99,235,.10); color:var(--primary2); font-size:11px;
      border:1px solid rgba(37,99,235,.15);
    }
    [data-theme="dark"] .pill{ background:rgba(147,197,253,.12); border-color:rgba(147,197,253,.18); }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:5px; }
    input, textarea, select{
      width:100%; font-family:inherit; font-size:13px;
      padding:9px 10px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--text); outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    textarea{ resize:vertical; min-height:82px; }

    .grid{ display:grid; gap:12px; grid-template-columns:repeat(12,1fr); }
    .col-3{ grid-column:span 3; }
    .col-4{ grid-column:span 4; }
    .col-6{ grid-column:span 6; }
    .col-12{ grid-column:span 12; }
    @media (max-width:980px){
      .col-3,.col-4{ grid-column:span 6; }
      .col-6{ grid-column:span 12; }
    }
    @media (max-width:560px){
      .col-3,.col-4{ grid-column:span 12; }
    }

    .btn-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .btn{
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(29,78,216,0);
      background:var(--primary); color:#fff; cursor:pointer; font-size:13px;
      transition: transform .06s ease, box-shadow .15s ease, opacity .15s ease, background .15s ease;
      box-shadow:0 10px 20px rgba(29,78,216,.22); user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); background:#1646c7; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn.ghost{
      background:transparent; color:var(--primary2);
      border:1px solid rgba(29,78,216,.22); box-shadow:none;
    }
    [data-theme="dark"] .btn.ghost{ border-color:rgba(147,197,253,.25); }
    .btn.ghost:hover{ background:rgba(37,99,235,.08); }

    .alert{
      border-radius:12px; padding:10px 12px;
      border:1px solid rgba(229,231,235,.9);
      background:rgba(107,114,128,.06);
      color:var(--text); font-size:13px; margin-top:10px; display:none;
    }
    [data-theme="dark"] .alert{ border-color:rgba(34,48,74,.9); background:rgba(156,163,175,.10); }
    .alert.show{ display:block; }
    .alert.danger{ border-color:rgba(185,28,28,.20); background:rgba(185,28,28,.08); }
    .alert.success{ border-color:rgba(4,120,87,.20); background:rgba(4,120,87,.08); }

    .stat{ display:grid; grid-template-columns:repeat(12,1fr); gap:10px; margin-top:10px; }
    .stat .item{
      grid-column:span 3; border:1px solid rgba(229,231,235,.9);
      border-radius:12px; padding:10px; background:var(--card);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
    }
    [data-theme="dark"] .stat .item{ border-color:rgba(34,48,74,.9); box-shadow:0 10px 24px rgba(0,0,0,.22); }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:16px; font-weight:700; margin-top:2px; }
    @media (max-width:980px){ .stat .item{ grid-column:span 6; } }
    @media (max-width:560px){ .stat .item{ grid-column:span 12; } }

    .table-wrap{
      width:100%; overflow:auto; border-radius:12px;
      border:1px solid rgba(229,231,235,.9); background:var(--card); margin-top:10px;
    }
    [data-theme="dark"] .table-wrap{ border-color:rgba(34,48,74,.9); }
    table{ width:100%; border-collapse:collapse; font-size:12px; min-width:760px; }
    th,td{
      border-bottom:1px solid rgba(229,231,235,.9);
      padding:8px 10px; text-align:right; white-space:nowrap;
    }
    [data-theme="dark"] th, [data-theme="dark"] td{ border-bottom-color:rgba(34,48,74,.9); }
    th{
      position:sticky; top:0; background:rgba(243,244,246,.9);
      font-weight:700; z-index:1; color:var(--text);
    }
    [data-theme="dark"] th{ background:#121b2f; }
    td:first-child, th:first-child{ text-align:left; }
    .neg{ color:var(--danger); font-weight:700; }
    .pos{ color:var(--success); font-weight:700; }

    .section{ display:none; }
    .section.active{ display:block; }

    .radio-line, .check-line{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:8px 0 0; font-size:13px;
    }
    .radio-line label, .check-line label{
      display:flex; align-items:center; gap:6px;
      margin:0; font-size:13px; color:var(--text);
    }
    input[type="radio"], input[type="checkbox"]{ width:auto; margin:0; accent-color:var(--primary); }

    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:99;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(720px, 100%); background:var(--card); color:var(--text);
      border:1px solid rgba(229,231,235,.9); border-radius:16px; box-shadow:var(--shadow);
      padding:14px;
    }
    [data-theme="dark"] .modal{ border-color:rgba(34,48,74,.9); }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .icon-btn{
      border:1px solid rgba(229,231,235,.9); background:transparent; color:var(--text);
      border-radius:10px; padding:8px 10px; cursor:pointer;
    }
    [data-theme="dark"] .icon-btn{ border-color:rgba(34,48,74,.9); }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div>
      <h1>金融小遊戲整合</h1>
      <p>投資／收支事件／保險／貸款，一個頁面搞定</p>
    </div>
    <div class="header-right">
      <span class="pill">自動保存</span>
      <button class="btn ghost" id="themeBtn" type="button" style="padding:9px 12px;">切換深色</button>
      <p class="mono" style="opacity:.9; margin:0;">v2.1</p>
    </div>
  </div>
</header>

<div class="container">
  <div class="tabs" role="tablist" aria-label="模組切換">
    <button class="tab-btn active" data-target="module-invest" role="tab" aria-selected="true">投資模擬</button>
    <button class="tab-btn" data-target="module-budget" role="tab" aria-selected="false">收支＋事件</button>
    <button class="tab-btn" data-target="module-insurance" role="tab" aria-selected="false">保險＋貸款</button>
  </div>

  <!-- ========== 模組一：投資 ========== -->
  <section id="module-invest" class="section active">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>投資模擬</h2>
          <p class="small">兩種算法：A 用總報酬率；B 拆股價成長＋殖利率（可選股利再投入）。</p>
        </div>
        <span class="pill">新增：年度明細＋匯出</span>
      </div>

      <div class="grid">
        <div class="col-3">
  <label>股票（可搜尋）</label>
  <input id="inv-stock-search" type="text" placeholder="輸入代號或名稱，例如 2330 或 台積電" />
  <select id="inv-stock" style="margin-top:8px;"></select>
  <div class="hint">選「其他／自訂」後可自行輸入代號。</div>
</div>

<div class="col-3">
  <label>自訂股票代號</label>
  <input id="inv-stock-custom" type="text" placeholder="例如：2330" disabled />
</div>

        <div class="col-3">
          <label>投資期間（年）</label>
          <input id="inv-years" type="number" min="1" value="10" />
        </div>

        <div class="col-6">
          <label>投入方式</label>
          <div class="radio-line">
            <label><input type="radio" name="inv-mode" value="lumpsum" checked /> 一次投入</label>
            <label><input type="radio" name="inv-mode" value="annual" /> 每年投入固定金額</label>
          </div>
          <div class="grid" style="margin-top:10px;">
            <div class="col-6">
              <label>一次投入金額</label>
              <input id="inv-lumpsum" type="number" min="0" value="100000" />
            </div>
            <div class="col-6">
              <label>每年投入金額</label>
              <input id="inv-annual" type="number" min="0" value="10000" />
            </div>
          </div>
        </div>
      </div>

      <h3>模式 A：總報酬率序列</h3>
      <div class="grid">
        <div class="col-6">
          <label>年報酬率（小數、逗號）</label>
          <textarea id="inv-returns" placeholder="例如：0.08,0.05,0.03,-0.02,0.1">0.08,0.05,0.03,-0.02,0.1</textarea>
          <div class="hint">適合：你已經把股價＋股利再投入都算成「總報酬率」。</div>
        </div>

        <div class="col-6">
          <h3 style="margin-top:0;">模式 B：股價成長＋殖利率</h3>
          <div class="grid">
            <div class="col-6">
              <label>起始股價</label>
              <input id="inv-start-price" type="number" min="0" value="100" />
            </div>
            <div class="col-6">
              <label>股利再投入</label>
              <select id="inv-reinvest">
                <option value="yes" selected>是</option>
                <option value="no">否（領現）</option>
              </select>
            </div>
            <div class="col-6">
              <label>年股價成長率（小數、逗號）</label>
              <input id="inv-growth" type="text" value="0.06,0.04,0.02,-0.03,0.08" />
            </div>
            <div class="col-6">
              <label>年股利殖利率（小數、逗號）</label>
              <input id="inv-divy" type="text" value="0.03,0.03,0.035,0.04,0.03" />
            </div>
            <div class="col-6">
              <label>股利稅/費（%）</label>
              <input id="inv-div-tax" type="number" step="0.1" value="0" />
            </div>
            <div class="col-6">
              <label>買入成本（%）</label>
              <input id="inv-fee" type="number" step="0.01" value="0" />
            </div>
          </div>
          <div class="hint">備註：這裡用「殖利率」估股利。若你要改成「每股股利 DPS」，程式裡有標註改法。</div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="runInvestment()">計算</button>
        <button class="btn ghost" onclick="exportInvestCSV()">匯出投資明細 CSV</button>
        <button class="btn ghost" onclick="resetInvest()">重設</button>
      </div>
      <div id="inv-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat" style="margin-top:12px;">
        <div class="item"><div class="k">投入成本</div><div class="v" id="inv-total-invest">-</div></div>
        <div class="item"><div class="k">最終財富</div><div class="v" id="inv-final-wealth">-</div></div>
        <div class="item"><div class="k">累積報酬率</div><div class="v" id="inv-total-return">-</div></div>
        <div class="item"><div class="k">年化報酬率（幾何）</div><div class="v" id="inv-annual-return">-</div></div>
      </div>

      <h3>年度明細</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>年</th>
              <th>投入</th>
              <th>股價</th>
              <th>股數</th>
              <th>股利（稅後）</th>
              <th>領現股利</th>
              <th>期末總資產</th>
            </tr>
          </thead>
          <tbody id="inv-table-body"></tbody>
        </table>
      </div>
      <div class="hint">提醒：這是「年」尺度的簡化示範；若你要月配/季配、配息日、手續費/證交稅更精準，可以再擴充。</div>
    </div>
  

  <div class="card" style="margin-top:14px;">
  <div class="card-header">
    <div>
      <h2>股利政策資料（Goodinfo）</h2>
      <p class="small">抓：股票股利、現金股利、年均價（需要啟動你自己的代理爬蟲 API）。</p>
    </div>
    <span class="pill">可保存到瀏覽器</span>
  </div>

  <div class="grid">
    <div class="col-3">
      <label>資料年度</label>
      <select id="div-year"></select>
      <div class="hint">抓到資料後可切換年度。</div>
    </div>
    <div class="col-3">
      <label>股票股利（元/股）</label>
      <input id="div-stock" type="number" step="0.0001" />
    </div>
    <div class="col-3">
      <label>現金股利（元/股）</label>
      <input id="div-cash" type="number" step="0.0001" />
    </div>
    <div class="col-3">
      <label>年均價（元）</label>
      <input id="div-avgprice" type="number" step="0.01" />
    </div>
  </div>

  <div class="btn-row">
    <button class="btn" type="button" onclick="fetchDividendFromProxy()">從 Goodinfo 更新</button>
    <button class="btn ghost" type="button" onclick="applyDividendToInvestModeB()">套用到模式 B</button>
    <button class="btn ghost" type="button" onclick="saveDividendManual()">手動保存（本機）</button>
    <button class="btn ghost" type="button" onclick="exportDividendDB()">匯出資料（JSON）</button>
  </div>

  <div id="div-alert" class="alert" role="alert" aria-live="polite"></div>
  <div class="hint">提醒：GitHub Pages 不能直接抓 Goodinfo（CORS）。請先在本機啟動代理 API（本包內 goodinfo-proxy）。</div>
</div>

</section>

  <!-- ========== 模組二：收支 + 事件 ========== -->
  <section id="module-budget" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>收支＋生活事件</h2>
          <p class="small">每回合＝1 個月：先入帳、再分桶、最後抽事件。</p>
        </div>
        <span class="pill">新增：回合復原＋自訂事件</span>
      </div>

      <h3>基本設定</h3>
      <div class="grid">
        <div class="col-3">
          <label>每月收入（元）</label>
          <input id="budget-income" type="number" min="0" value="65000" />
        </div>
        <div class="col-3">
          <label>民生必需品 %</label>
          <input id="pct-necessities" type="number" min="0" max="100" value="30" />
        </div>
        <div class="col-3">
          <label>緊急預備金 %</label>
          <input id="pct-emergency" type="number" min="0" max="100" value="20" />
        </div>
        <div class="col-3">
          <label>娛樂支出 %</label>
          <input id="pct-entertainment" type="number" min="0" max="100" value="10" />
        </div>
        <div class="col-3">
          <label>投資 %</label>
          <input id="pct-invest" type="number" min="0" max="100" value="20" />
        </div>
        <div class="col-3">
          <label>起始現金</label>
          <input id="budget-start-cash" type="number" min="0" value="65000" />
        </div>
        <div class="col-6">
          <label>事件強度（越大越常觸發）</label>
          <input id="budget-event-intensity" type="number" min="0" max="300" value="100" />
          <div class="hint">100 = 正常；50 = 比較少事；150 = 事件很多。</div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" id="budget-start-btn" onclick="startBudgetGame()">開始／重新開始</button>
        <button class="btn" id="budget-next-btn" onclick="nextBudgetTurn()" disabled>下一回合</button>
        <button class="btn ghost" id="budget-undo-btn" onclick="undoBudgetTurn()" disabled>復原上一回合</button>
        <button class="btn ghost" onclick="openEventModal()">新增自訂事件</button>
        <button class="btn ghost" onclick="exportBudgetCSV()">匯出 CSV</button>
        <button class="btn ghost" onclick="clearBudgetLog()">清除紀錄</button>
      </div>
      <div id="budget-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item"><div class="k">回合數</div><div class="v" id="budget-turn">-</div></div>
        <div class="item"><div class="k">現金餘額</div><div class="v" id="budget-cash">-</div></div>
        <div class="item"><div class="k">必需品累積</div><div class="v" id="bucket-necessities">-</div></div>
        <div class="item"><div class="k">緊急預備金累積</div><div class="v" id="bucket-emergency">-</div></div>
        <div class="item"><div class="k">娛樂累積</div><div class="v" id="bucket-entertainment">-</div></div>
        <div class="item"><div class="k">投資累積</div><div class="v" id="bucket-invest">-</div></div>
        <div class="item"><div class="k">其他累積</div><div class="v" id="bucket-other">-</div></div>
      </div>

      <h3>事件紀錄</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>回合</th>
              <th>月收入</th>
              <th>分配（必需/緊急/娛樂/投資/其他）</th>
              <th>事件</th>
              <th>事件金額</th>
              <th>回合後現金</th>
              <th>說明</th>
            </tr>
          </thead>
          <tbody id="budget-log-body"></tbody>
        </table>
      </div>

      <div class="hint">小提醒：自訂事件會保存到你的瀏覽器（localStorage）。</div>
    </div>
  </section>

  <!-- ========== 模組三：保險 + 貸款 ========== -->
  <section id="module-insurance" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>保險小遊戲</h2>
          <p class="small">每回合＝1 年：先扣保費，再判定事故。有保險拿理賠；沒保險用自付成本。</p>
        </div>
        <span class="pill">可匯出 CSV</span>
      </div>

      <h3>參數</h3>
      <div class="grid">
        <div class="col-3"><label>起始現金</label><input id="ins-start-cash" type="number" value="120000" /></div>
        <div class="col-3"><label>起始年齡</label><input id="ins-start-age" type="number" value="24" /></div>
        <div class="col-3"><label>總回合（年）</label><input id="ins-max-turns" type="number" value="15" /></div>
      </div>

      <div class="grid" style="margin-top:8px;">
        <div class="col-3">
          <h3>保費</h3>
          <label>壽險</label><input id="ins-prem-life" type="number" value="6000" />
          <label>醫療險</label><input id="ins-prem-medical" type="number" value="4500" />
          <label>財產險</label><input id="ins-prem-property" type="number" value="3000" />
        </div>
        <div class="col-3">
          <h3>事故機率</h3>
          <label>壽險</label><input id="ins-prob-life" type="number" step="0.01" value="0.01" />
          <label>醫療</label><input id="ins-prob-medical" type="number" step="0.01" value="0.12" />
          <label>財產</label><input id="ins-prob-property" type="number" step="0.01" value="0.06" />
        </div>
        <div class="col-3">
          <h3>理賠</h3>
          <label>壽險</label><input id="ins-payout-life" type="number" value="500000" />
          <label>醫療</label><input id="ins-payout-medical" type="number" value="50000" />
          <label>財產</label><input id="ins-payout-property" type="number" value="120000" />
        </div>
        <div class="col-3">
          <h3>沒保險自付成本</h3>
          <label>壽險事故成本</label><input id="ins-costno-life" type="number" value="300000" />
          <label>醫療事故成本</label><input id="ins-costno-medical" type="number" value="30000" />
          <label>財產事故成本</label><input id="ins-costno-property" type="number" value="80000" />
        </div>
      </div>

      <div class="check-line" style="margin-top:8px;">
        <label><input type="checkbox" id="ins-has-life" checked /> 投保壽險</label>
        <label><input type="checkbox" id="ins-has-medical" checked /> 投保醫療險</label>
        <label><input type="checkbox" id="ins-has-property" checked /> 投保財產險</label>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="startInsGame()">開始</button>
        <button class="btn" id="ins-next-btn" onclick="nextInsTurn()" disabled>下一回合</button>
        <button class="btn ghost" onclick="exportInsCSV()">匯出 CSV</button>
        <button class="btn ghost" onclick="clearInsLog()">清除紀錄</button>
      </div>
      <div id="ins-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item"><div class="k">年齡</div><div class="v" id="ins-age">-</div></div>
        <div class="item"><div class="k">回合</div><div class="v" id="ins-turn">-</div></div>
        <div class="item"><div class="k">現金餘額</div><div class="v" id="ins-cash">-</div></div>
        <div class="item"><div class="k">累積保費</div><div class="v" id="ins-total-prem">-</div></div>
        <div class="item"><div class="k">累積理賠</div><div class="v" id="ins-total-payout">-</div></div>
        <div class="item"><div class="k">累積自付</div><div class="v" id="ins-total-outofpocket">-</div></div>
      </div>

      <h3>事件紀錄</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>回合</th>
              <th>年齡</th>
              <th>保費支出</th>
              <th>理賠收入</th>
              <th>自付（沒保險）</th>
              <th>事故說明</th>
              <th>回合後現金</th>
            </tr>
          </thead>
          <tbody id="ins-log-body"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <h2>貸款攤還表</h2>
          <p class="small">支援 0% 利率；最後一期自動補差，避免浮點誤差。</p>
        </div>
        <span class="pill">可複製回 Excel</span>
      </div>

      <div class="grid">
        <div class="col-3"><label>本金</label><input id="loan-principal" type="number" value="500000" /></div>
        <div class="col-3"><label>年利率（%）</label><input id="loan-rate" type="number" step="0.01" value="2" /></div>
        <div class="col-3"><label>年限（年）</label><input id="loan-years" type="number" value="15" /></div>
        <div class="col-3"><label>每年付款次數</label><input id="loan-nperyear" type="number" value="12" /></div>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="calcLoan()">計算</button>
        <button class="btn ghost" onclick="clearLoan()">清除</button>
      </div>
      <div id="loan-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item"><div class="k">每期應付</div><div class="v" id="loan-payment">-</div></div>
        <div class="item"><div class="k">總利息</div><div class="v" id="loan-total-interest">-</div></div>
        <div class="item"><div class="k">總還款</div><div class="v" id="loan-total-paid">-</div></div>
      </div>

      <h3>攤還明細</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>期數</th>
              <th>每期付款</th>
              <th>本金</th>
              <th>利息</th>
              <th>剩餘本金</th>
            </tr>
          </thead>
          <tbody id="loan-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- 自訂事件 Modal -->
<div class="modal-backdrop" id="eventModal" role="dialog" aria-modal="true" aria-label="新增自訂事件">
  <div class="modal">
    <div class="modal-head">
      <div>
        <h3 style="margin:0;">新增自訂事件</h3>
        <div class="hint" style="margin-top:4px;">權重越大越容易抽到；金額可正可負。</div>
      </div>
      <button class="icon-btn" type="button" onclick="closeEventModal()">關閉</button>
    </div>
    <div class="grid" style="margin-top:10px;">
      <div class="col-6">
        <label>事件名稱</label>
        <input id="evt-name" type="text" placeholder="例如：手機壞掉" />
      </div>
      <div class="col-6">
        <label>事件金額（元）</label>
        <input id="evt-delta" type="number" placeholder="-8000 或 20000" />
      </div>
      <div class="col-12">
        <label>說明</label>
        <textarea id="evt-desc" placeholder="簡短說明就好"></textarea>
      </div>
      <div class="col-6">
        <label>權重（1~100）</label>
        <input id="evt-weight" type="number" min="1" max="100" value="10" />
      </div>
      <div class="col-6">
        <label>快速管理</label>
        <div class="btn-row" style="margin-top:0;">
          <button class="btn" type="button" onclick="addCustomEvent()">加入事件</button>
          <button class="btn ghost" type="button" onclick="clearCustomEvents()">清空自訂事件</button>
        </div>
      </div>
    </div>
    <div id="evt-alert" class="alert" role="alert" aria-live="polite"></div>
  </div>
</div>

<script>
  /* =========================
     共用工具
  ========================= */
  const LS_KEY = "finance_game_v21_state";
  const LS_THEME = "finance_game_theme";
  const LS_BUDGET_EVENTS = "finance_game_budget_events_v1";

  function formatMoney(num){
    if (num === null || num === undefined || isNaN(num)) return "-";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 2 });
  }
  function parseNumberById(id){
    const v = parseFloat(document.getElementById(id).value);
    return isNaN(v) ? 0 : v;
  }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function showAlert(id, msg, type="danger"){
    const el = document.getElementById(id);
    el.className = "alert show " + (type === "success" ? "success" : "danger");
    el.textContent = msg;
  }
  function hideAlert(id){
    const el = document.getElementById(id);
    el.className = "alert";
    el.textContent = "";
  }

  function toCSV(rows){
    const esc = (s) => {
      const str = String(s ?? "");
      if (/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
      return str;
    };
    return rows.map(r => r.map(esc).join(",")).join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  /* =========================
     深色模式
  ========================= */
  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(LS_THEME, theme);
    document.getElementById("themeBtn").textContent = theme === "dark" ? "切換淺色" : "切換深色";
  }
  (function initTheme(){
    const saved = localStorage.getItem(LS_THEME);
    const theme = saved || "light";
    setTheme(theme);
  })();
  document.getElementById("themeBtn").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "light";
    setTheme(cur === "dark" ? "light" : "dark");
  });

  /* =========================
     Tabs（含 hash）
  ========================= */
  const tabBtns = document.querySelectorAll(".tab-btn");
  const sections = document.querySelectorAll(".section");

  function activateTab(targetId){
    tabBtns.forEach(b => {
      const active = b.dataset.target === targetId;
      b.classList.toggle("active", active);
      b.setAttribute("aria-selected", active ? "true" : "false");
    });
    sections.forEach(sec => sec.classList.toggle("active", sec.id === targetId));
    location.hash = targetId;
  }
  tabBtns.forEach(btn=> btn.addEventListener("click", ()=> activateTab(btn.dataset.target)));

  if (location.hash){
    const id = location.hash.replace("#","");
    if (document.getElementById(id)) activateTab(id);
  }

  /* =========================
     localStorage：保存/還原
  ========================= */
  const watchIds = [
    // invest
    "inv-stock","inv-years","inv-lumpsum","inv-annual","inv-returns",
    "inv-start-price","inv-reinvest","inv-growth","inv-divy","inv-div-tax","inv-fee",
    // budget
    "budget-income","pct-necessities","pct-emergency","pct-entertainment","pct-invest","budget-start-cash","budget-event-intensity",
    // insurance
    "ins-start-cash","ins-start-age","ins-max-turns",
    "ins-prem-life","ins-prem-medical","ins-prem-property",
    "ins-prob-life","ins-prob-medical","ins-prob-property",
    "ins-payout-life","ins-payout-medical","ins-payout-property",
    "ins-costno-life","ins-costno-medical","ins-costno-property",
    "ins-has-life","ins-has-medical","ins-has-property",
    // loan
    "loan-principal","loan-rate","loan-years","loan-nperyear"
  ];

  function saveState(){
    const data = {};
    watchIds.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") data[id] = el.checked;
      else data[id] = el.value;
    });
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }
  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try{
      const data = JSON.parse(raw);
      Object.keys(data).forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox") el.checked = !!data[id];
        else el.value = data[id];
      });
    }catch(e){}
  }

  loadState();
  watchIds.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", saveState);
    el.addEventListener("change", saveState);
  });

  /* =========================
     模組一：投資（含年度明細）
  ========================= */
  function parseSeries(text){
    return String(text || "")
      .split(",")
      .map(s => parseFloat(s.trim()))
      .filter(v => !isNaN(v));
  }

  let investLastRows = []; // for export
  let investLastMode = ""; // A or B

  function renderInvestTable(rows){
    const tbody = document.getElementById("inv-table-body");
    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      r.forEach((v, idx)=>{
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function runInvestment(){
    hideAlert("inv-alert");
    investLastRows = [];
    investLastMode = "";

    const years = parseInt(document.getElementById("inv-years").value, 10) || 0;
    if (years <= 0){ showAlert("inv-alert","投資期間請輸入正整數。"); return; }

    const mode = document.querySelector('input[name="inv-mode"]:checked').value;
    const lump = parseNumberById("inv-lumpsum");
    const annual = parseNumberById("inv-annual");
    if (mode === "lumpsum" && lump <= 0){ showAlert("inv-alert","一次投入金額需大於 0。"); return; }
    if (mode === "annual" && annual <= 0){ showAlert("inv-alert","每年投入金額需大於 0。"); return; }

    const returnsA = parseSeries(document.getElementById("inv-returns").value);
    const startPrice = parseNumberById("inv-start-price");
    const growth = parseSeries(document.getElementById("inv-growth").value);
    const divy = parseSeries(document.getElementById("inv-divy").value);

    const useB = (startPrice > 0) && (growth.length > 0 || divy.length > 0);

    let totalInvest = 0;
    let finalWealth = 0;
    let detailRows = [];

    if (!useB){
      // ===== 模式 A：總報酬率 =====
      investLastMode = "A";
      if (returnsA.length === 0){
        showAlert("inv-alert","模式 A：請至少輸入一個年報酬率（例如 0.08,0.05,...）。");
        return;
      }
      let wealth = 0;
      let shares = 0;       // 這裡僅為表格欄位一致，模式 A 不追蹤股數/股價
      let price = 0;
      let cashDiv = 0;
      for (let i=0;i<years;i++){
        const r = returnsA[Math.min(i, returnsA.length-1)];
        const contribution = (mode === "lumpsum" ? (i===0 ? lump : 0) : annual);

        wealth = (wealth + contribution) * (1 + r);
        totalInvest += contribution;

        detailRows.push([
          String(i+1),
          formatMoney(contribution),
          price ? formatMoney(price) : "-",
          shares ? formatMoney(shares) : "-",
          "-",
          cashDiv ? formatMoney(cashDiv) : "-",
          formatMoney(wealth)
        ]);
      }
      finalWealth = wealth;
    }else{
      // ===== 模式 B：股價成長 + 股利殖利率 =====
      investLastMode = "B";
      const reinvest = document.getElementById("inv-reinvest").value === "yes";
      const divTax = clamp(parseNumberById("inv-div-tax") / 100, 0, 1);
      const fee = clamp(parseNumberById("inv-fee") / 100, 0, 1);

      let price = startPrice;
      let shares = 0;
      let cashDividend = 0;

      function applyContribution(amount){
        if (amount <= 0) return 0;
        const buyable = amount * (1 - fee);
        shares += buyable / price;
        totalInvest += amount;
        return amount;
      }

      if (mode === "lumpsum") applyContribution(lump);

      for (let i=0;i<years;i++){
        const contribution = (mode === "annual") ? applyContribution(annual) : 0;

        const g = growth.length ? growth[Math.min(i, growth.length-1)] : 0;
        const dy = divy.length ? divy[Math.min(i, divy.length-1)] : 0;

        // 年末股價
        price = price * (1 + g);

        // 股利（殖利率簡化）
        const value = shares * price;
        // 若你要改 DPS：把下一行改成  const dividend = shares * dps;
        const dividend = value * dy;

        const netDividend = dividend * (1 - divTax);

        if (reinvest){
          const buyable = netDividend * (1 - fee);
          shares += buyable / price;
        }else{
          cashDividend += netDividend;
        }

        const wealth = shares * price + cashDividend;

        detailRows.push([
          String(i+1),
          formatMoney(contribution),
          formatMoney(price),
          formatMoney(shares),
          formatMoney(netDividend),
          cashDividend ? formatMoney(cashDividend) : "0",
          formatMoney(wealth)
        ]);
      }

      finalWealth = shares * price + cashDividend;
      if (totalInvest <= 0){ showAlert("inv-alert","投入成本為 0，無法計算報酬率。"); return; }
    }

    const totalReturn = finalWealth / totalInvest - 1;
    const annualReturn = Math.pow(1 + totalReturn, 1 / years) - 1;

    document.getElementById("inv-total-invest").textContent = formatMoney(totalInvest);
    document.getElementById("inv-final-wealth").textContent = formatMoney(finalWealth);
    document.getElementById("inv-total-return").textContent = (totalReturn * 100).toFixed(2) + "%";
    document.getElementById("inv-annual-return").textContent = (annualReturn * 100).toFixed(2) + "%";

    investLastRows = detailRows;
    renderInvestTable(detailRows);

    showAlert("inv-alert", `已完成計算（模式 ${useB ? "B" : "A"}）。`, "success");
  }

  function exportInvestCSV(){
    if (!investLastRows || investLastRows.length === 0){
      showAlert("inv-alert","請先計算一次，才有明細可匯出。");
      return;
    }
    const stock = document.getElementById("inv-stock").value || "stock";
    const header = [[
      "年","投入","股價","股數","股利(稅後)","領現股利","期末總資產"
    ]];
    const csv = toCSV(header.concat(investLastRows));
    downloadText(`invest_${stock}_mode${investLastMode}.csv`, csv);
    showAlert("inv-alert","已匯出投資明細 CSV。","success");
  }

  function resetInvest(){
    document.getElementById("inv-years").value = 10;
    document.getElementById("inv-lumpsum").value = 100000;
    document.getElementById("inv-annual").value = 10000;
    document.getElementById("inv-returns").value = "0.08,0.05,0.03,-0.02,0.1";
    document.getElementById("inv-start-price").value = 100;
    document.getElementById("inv-reinvest").value = "yes";
    document.getElementById("inv-growth").value = "0.06,0.04,0.02,-0.03,0.08";
    document.getElementById("inv-divy").value = "0.03,0.03,0.035,0.04,0.03";
    document.getElementById("inv-div-tax").value = 0;
    document.getElementById("inv-fee").value = 0;

    ["inv-total-invest","inv-final-wealth","inv-total-return","inv-annual-return"].forEach(id=>{
      document.getElementById(id).textContent = "-";
    });
    document.getElementById("inv-table-body").innerHTML = "";
    investLastRows = [];
    hideAlert("inv-alert");
    saveState();
  }

  /* =========================
     模組二：收支 + 事件（含復原、自訂事件）
  ========================= */
  const defaultBudgetEvents = [
    { name:"家電壞掉", delta:-8000, desc:"突發維修或換新。", weight:12 },
    { name:"物價上漲", delta:-3000, desc:"生活成本變高。", weight:10 },
    { name:"獎金入帳", delta:20000, desc:"工作表現不錯。", weight:8 },
    { name:"尾牙中獎", delta:100000, desc:"一次性獎金。", weight:2 },
    { name:"意外支出", delta:-6000, desc:"臨時開銷。", weight:10 },
    { name:"旅行超支", delta:-13000, desc:"行程花費超出預期。", weight:6 },
    { name:"投資小漲", delta:5000, desc:"投資部位小幅獲利。", weight:7 },
    { name:"投資小跌", delta:-5000, desc:"投資部位小幅虧損。", weight:7 }
  ];

  function loadBudgetEvents(){
    const raw = localStorage.getItem(LS_BUDGET_EVENTS);
    if (!raw) return defaultBudgetEvents.slice();
    try{
      const arr = JSON.parse(raw);
      if (Array.isArray(arr) && arr.length) return arr;
      return defaultBudgetEvents.slice();
    }catch(e){
      return defaultBudgetEvents.slice();
    }
  }
  function saveBudgetEvents(events){
    localStorage.setItem(LS_BUDGET_EVENTS, JSON.stringify(events));
  }

  function pickWeighted(events, intensity=100){
    // intensity 100 = 原權重；其他 = 乘倍率
    const mult = clamp(intensity, 0, 300) / 100;
    const weights = events.map(e => Math.max(0, (Number(e.weight)||0) * mult));
    const total = weights.reduce((a,b)=>a+b,0);
    if (total <= 0) return null;
    let r = Math.random() * total;
    for (let i=0;i<events.length;i++){
      r -= weights[i];
      if (r <= 0) return events[i];
    }
    return events[events.length-1];
  }

  let budgetEvents = loadBudgetEvents();
  let budgetState = null;

  function renderBuckets(){
    const b = budgetState.buckets;
    document.getElementById("bucket-necessities").textContent = formatMoney(b.necessities);
    document.getElementById("bucket-emergency").textContent = formatMoney(b.emergency);
    document.getElementById("bucket-entertainment").textContent = formatMoney(b.entertainment);
    document.getElementById("bucket-invest").textContent = formatMoney(b.invest);
    document.getElementById("bucket-other").textContent = formatMoney(b.other);
  }

  function renderBudgetLog(){
    const tbody = document.getElementById("budget-log-body");
    tbody.innerHTML = "";
    if (!budgetState) return;
    budgetState.log.forEach(row=>{
      const tr = document.createElement("tr");
      row.forEach((v, idx)=>{
        const td = document.createElement("td");
        td.textContent = v;
        if (idx === 4){
          const n = String(v).startsWith("-") ? -1 : 1;
          td.className = n < 0 ? "neg" : "pos";
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function startBudgetGame(){
    hideAlert("budget-alert");
    const income = parseNumberById("budget-income");
    const startCash = parseNumberById("budget-start-cash");
    if (income <= 0){ showAlert("budget-alert","每月收入需大於 0。"); return; }

    const pNec = clamp(parseNumberById("pct-necessities"), 0, 100);
    const pEmg = clamp(parseNumberById("pct-emergency"), 0, 100);
    const pEnt = clamp(parseNumberById("pct-entertainment"), 0, 100);
    const pInv = clamp(parseNumberById("pct-invest"), 0, 100);

    const sumP = pNec + pEmg + pEnt + pInv;
    if (sumP > 100){ showAlert("budget-alert","百分比總和不可超過 100%。"); return; }

    budgetState = {
      turn: 0,
      cash: startCash,
      income,
      percents: { necessities:pNec, emergency:pEmg, entertainment:pEnt, invest:pInv },
      buckets: { necessities:0, emergency:0, entertainment:0, invest:0, other:0 },
      log: [],
      snapshots: [] // 用來復原
    };

    document.getElementById("budget-turn").textContent = "0";
    document.getElementById("budget-cash").textContent = formatMoney(budgetState.cash);
    renderBuckets();
    renderBudgetLog();

    document.getElementById("budget-next-btn").disabled = false;
    document.getElementById("budget-undo-btn").disabled = true;

    showAlert("budget-alert","已開始新遊戲。","success");
  }

  function nextBudgetTurn(){
    hideAlert("budget-alert");
    if (!budgetState){ showAlert("budget-alert","請先開始遊戲。"); return; }

    // snapshot for undo
    budgetState.snapshots.push(JSON.parse(JSON.stringify({
      turn: budgetState.turn,
      cash: budgetState.cash,
      buckets: budgetState.buckets,
      log: budgetState.log
    })));

    budgetState.turn += 1;

    // 1) 入帳收入
    budgetState.cash += budgetState.income;

    // 2) 分桶
    const inc = budgetState.income;
    const p = budgetState.percents;
    const nec = inc * p.necessities/100;
    const emg = inc * p.emergency/100;
    const ent = inc * p.entertainment/100;
    const inv = inc * p.invest/100;
    const other = inc - (nec + emg + ent + inv);

    budgetState.cash -= (nec + emg + ent + inv + other);

    budgetState.buckets.necessities += nec;
    budgetState.buckets.emergency += emg;
    budgetState.buckets.entertainment += ent;
    budgetState.buckets.invest += inv;
    budgetState.buckets.other += other;

    // 3) 事件
    const intensity = parseNumberById("budget-event-intensity");
    const event = pickWeighted(budgetEvents, intensity);
    if (!event){
      showAlert("budget-alert","事件權重為 0（沒有事件可抽）。請調整事件強度或新增事件。");
      return;
    }
    budgetState.cash += Number(event.delta) || 0;

    // 顯示
    document.getElementById("budget-turn").textContent = String(budgetState.turn);
    document.getElementById("budget-cash").textContent = formatMoney(budgetState.cash);
    renderBuckets();

    const allocationText = `${formatMoney(nec)} / ${formatMoney(emg)} / ${formatMoney(ent)} / ${formatMoney(inv)} / ${formatMoney(other)}`;
    const deltaText = ((Number(event.delta)||0) >= 0 ? "+" : "") + formatMoney(event.delta);

    const row = [
      budgetState.turn,
      formatMoney(budgetState.income),
      allocationText,
      event.name,
      deltaText,
      formatMoney(budgetState.cash),
      event.desc || ""
    ];
    budgetState.log.push(row);
    renderBudgetLog();

    document.getElementById("budget-undo-btn").disabled = budgetState.snapshots.length === 0;
  }

  function undoBudgetTurn(){
    hideAlert("budget-alert");
    if (!budgetState || budgetState.snapshots.length === 0){
      showAlert("budget-alert","目前沒有可復原的回合。");
      return;
    }
    const snap = budgetState.snapshots.pop();

    budgetState.turn = snap.turn;
    budgetState.cash = snap.cash;
    budgetState.buckets = snap.buckets;
    budgetState.log = snap.log;

    document.getElementById("budget-turn").textContent = String(budgetState.turn);
    document.getElementById("budget-cash").textContent = formatMoney(budgetState.cash);
    renderBuckets();
    renderBudgetLog();

    document.getElementById("budget-undo-btn").disabled = budgetState.snapshots.length === 0;
    showAlert("budget-alert","已復原上一回合。","success");
  }

  function clearBudgetLog(){
    if (!budgetState){
      document.getElementById("budget-log-body").innerHTML = "";
      hideAlert("budget-alert");
      return;
    }
    budgetState.log = [];
    budgetState.snapshots = [];
    document.getElementById("budget-log-body").innerHTML = "";
    document.getElementById("budget-undo-btn").disabled = true;
    showAlert("budget-alert","已清除紀錄。","success");
  }

  function exportBudgetCSV(){
    if (!budgetState || budgetState.log.length === 0){
      showAlert("budget-alert","目前沒有可匯出的紀錄。");
      return;
    }
    const header = [["回合","月收入","分配(必需/緊急/娛樂/投資/其他)","事件","事件金額","回合後現金","說明"]];
    const csv = toCSV(header.concat(budgetState.log));
    downloadText("budget_log.csv", csv);
    showAlert("budget-alert","已匯出 budget_log.csv","success");
  }

  /* =========================
     自訂事件 Modal
  ========================= */
  function openEventModal(){
    hideAlert("evt-alert");
    document.getElementById("eventModal").classList.add("show");
  }
  function closeEventModal(){
    document.getElementById("eventModal").classList.remove("show");
  }
  document.getElementById("eventModal").addEventListener("click", (e)=>{
    if (e.target.id === "eventModal") closeEventModal();
  });

  function addCustomEvent(){
    hideAlert("evt-alert");
    const name = String(document.getElementById("evt-name").value || "").trim();
    const delta = parseFloat(document.getElementById("evt-delta").value);
    const desc = String(document.getElementById("evt-desc").value || "").trim();
    const weight = clamp(parseInt(document.getElementById("evt-weight").value,10) || 0, 1, 100);

    if (!name){ showAlert("evt-alert","請輸入事件名稱。"); return; }
    if (isNaN(delta) || delta === 0){ showAlert("evt-alert","事件金額請輸入非 0 數字（可正可負）。"); return; }

    budgetEvents.push({ name, delta, desc, weight });
    saveBudgetEvents(budgetEvents);

    document.getElementById("evt-name").value = "";
    document.getElementById("evt-delta").value = "";
    document.getElementById("evt-desc").value = "";
    document.getElementById("evt-weight").value = 10;

    showAlert("evt-alert","已新增事件，並保存到瀏覽器。","success");
  }

  function clearCustomEvents(){
    hideAlert("evt-alert");
    budgetEvents = defaultBudgetEvents.slice();
    saveBudgetEvents(budgetEvents);
    showAlert("evt-alert","已清空自訂事件（回到預設事件）。","success");
  }

  /* =========================
     模組三：保險
  ========================= */
  let insState = null;

  function startInsGame(){
    hideAlert("ins-alert");
    const cash = parseNumberById("ins-start-cash");
    const age = parseInt(document.getElementById("ins-start-age").value,10) || 0;
    const maxTurns = parseInt(document.getElementById("ins-max-turns").value,10) || 0;
    if (cash <= 0 || age <= 0 || maxTurns <= 0){
      showAlert("ins-alert","請確認起始現金、年齡、回合數皆為正數。");
      return;
    }

    insState = { age, turn:0, maxTurns, cash, totalPrem:0, totalPayout:0, totalOut:0, log:[] };

    document.getElementById("ins-age").textContent = insState.age;
    document.getElementById("ins-turn").textContent = insState.turn;
    document.getElementById("ins-cash").textContent = formatMoney(insState.cash);
    document.getElementById("ins-total-prem").textContent = formatMoney(0);
    document.getElementById("ins-total-payout").textContent = formatMoney(0);
    document.getElementById("ins-total-outofpocket").textContent = formatMoney(0);
    document.getElementById("ins-log-body").innerHTML = "";
    document.getElementById("ins-next-btn").disabled = false;

    showAlert("ins-alert","已開始。","success");
  }

  function nextInsTurn(){
    hideAlert("ins-alert");
    if (!insState){ showAlert("ins-alert","請先開始。"); return; }
    if (insState.turn >= insState.maxTurns){
      showAlert("ins-alert","已到達最大回合數。");
      document.getElementById("ins-next-btn").disabled = true;
      return;
    }

    const premLife = parseNumberById("ins-prem-life");
    const premMed  = parseNumberById("ins-prem-medical");
    const premProp = parseNumberById("ins-prem-property");

    const probLife = clamp(parseFloat(document.getElementById("ins-prob-life").value) || 0, 0, 1);
    const probMed  = clamp(parseFloat(document.getElementById("ins-prob-medical").value) || 0, 0, 1);
    const probProp = clamp(parseFloat(document.getElementById("ins-prob-property").value) || 0, 0, 1);

    const payoutLife = parseNumberById("ins-payout-life");
    const payoutMed  = parseNumberById("ins-payout-medical");
    const payoutProp = parseNumberById("ins-payout-property");

    const costNoLife = parseNumberById("ins-costno-life");
    const costNoMed  = parseNumberById("ins-costno-medical");
    const costNoProp = parseNumberById("ins-costno-property");

    const hasLife = document.getElementById("ins-has-life").checked;
    const hasMed  = document.getElementById("ins-has-medical").checked;
    const hasProp = document.getElementById("ins-has-property").checked;

    insState.turn += 1;
    insState.age += 1;

    let premThis = 0, payoutThis = 0, outThis = 0;
    let descs = [];

    if (hasLife) premThis += premLife;
    if (hasMed)  premThis += premMed;
    if (hasProp) premThis += premProp;

    insState.cash -= premThis;
    insState.totalPrem += premThis;

    const lifeHit = Math.random() < probLife;
    const medHit  = Math.random() < probMed;
    const propHit = Math.random() < probProp;

    function handle(hit, has, payout, cost, label){
      if (!hit) return;
      if (has){
        payoutThis += payout;
        descs.push(`${label}：理賠 +${formatMoney(payout)}`);
      }else{
        outThis += cost;
        descs.push(`${label}：自付 -${formatMoney(cost)}`);
      }
    }

    handle(lifeHit, hasLife, payoutLife, costNoLife, "壽險事故");
    handle(medHit,  hasMed,  payoutMed,  costNoMed,  "醫療事故");
    handle(propHit, hasProp, payoutProp, costNoProp, "財產事故");

    if (!lifeHit && !medHit && !propHit) descs.push("本回合無事故");

    insState.cash += payoutThis;
    insState.cash -= outThis;

    insState.totalPayout += payoutThis;
    insState.totalOut += outThis;

    document.getElementById("ins-age").textContent = insState.age;
    document.getElementById("ins-turn").textContent = insState.turn;
    document.getElementById("ins-cash").textContent = formatMoney(insState.cash);
    document.getElementById("ins-total-prem").textContent = formatMoney(insState.totalPrem);
    document.getElementById("ins-total-payout").textContent = formatMoney(insState.totalPayout);
    document.getElementById("ins-total-outofpocket").textContent = formatMoney(insState.totalOut);

    const row = [
      insState.turn,
      insState.age,
      "-" + formatMoney(premThis),
      "+" + formatMoney(payoutThis),
      "-" + formatMoney(outThis),
      descs.join("；"),
      formatMoney(insState.cash)
    ];
    insState.log.push(row);

    const tr = document.createElement("tr");
    row.forEach((v, idx)=>{
      const td = document.createElement("td");
      td.textContent = v;
      if (idx===2 && premThis>0) td.className="neg";
      if (idx===3 && payoutThis>0) td.className="pos";
      if (idx===4 && outThis>0) td.className="neg";
      tr.appendChild(td);
    });
    document.getElementById("ins-log-body").appendChild(tr);

    if (insState.turn >= insState.maxTurns){
      document.getElementById("ins-next-btn").disabled = true;
      showAlert("ins-alert","已到達最大回合數。","success");
    }
  }

  function clearInsLog(){
    if (!insState){
      document.getElementById("ins-log-body").innerHTML = "";
      hideAlert("ins-alert");
      return;
    }
    insState.log = [];
    document.getElementById("ins-log-body").innerHTML = "";
    showAlert("ins-alert","已清除紀錄。","success");
  }

  function exportInsCSV(){
    if (!insState || insState.log.length === 0){
      showAlert("ins-alert","目前沒有可匯出的紀錄。");
      return;
    }
    const header = [["回合","年齡","保費支出","理賠收入","自付(沒保險)","事故說明","回合後現金"]];
    const csv = toCSV(header.concat(insState.log));
    downloadText("insurance_log.csv", csv);
    showAlert("ins-alert","已匯出 insurance_log.csv","success");
  }

  /* =========================
     模組三：貸款
  ========================= */
  function calcLoan(){
    hideAlert("loan-alert");
    const principal = parseNumberById("loan-principal");
    const rateAnnual = (parseFloat(document.getElementById("loan-rate").value) || 0) / 100;
    const years = parseInt(document.getElementById("loan-years").value,10) || 0;
    const nperYear = parseInt(document.getElementById("loan-nperyear").value,10) || 0;

    if (principal <= 0 || years <= 0 || nperYear <= 0){
      showAlert("loan-alert","請確認本金、年限、每年付款次數皆為正數。");
      return;
    }
    if (rateAnnual < 0){
      showAlert("loan-alert","年利率不可為負數。");
      return;
    }

    const n = years * nperYear;
    const r = rateAnnual / nperYear;

    let payment = 0;
    if (r === 0) payment = principal / n;
    else payment = principal * r / (1 - Math.pow(1 + r, -n));

    let balance = principal;
    let totalInterest = 0;
    const tbody = document.getElementById("loan-tabl


/* ========================= 股票選擇（30+ 可搜尋 + 自訂）========================= */
const STOCK_UNIVERSE = [
  { id:"2330", name:"台積電" },
  { id:"2317", name:"鴻海" },
  { id:"2454", name:"聯發科" },
  { id:"2308", name:"台達電" },
  { id:"2881", name:"富邦金" },
  { id:"2882", name:"國泰金" },
  { id:"2891", name:"中信金" },
  { id:"2884", name:"玉山金" },
  { id:"2886", name:"兆豐金" },
  { id:"5880", name:"合庫金" },
  { id:"5871", name:"中租-KY" },
  { id:"3711", name:"日月光投控" },
  { id:"2412", name:"中華電" },
  { id:"3045", name:"台灣大" },
  { id:"3008", name:"大立光" },
  { id:"2002", name:"中鋼" },
  { id:"1216", name:"統一" },
  { id:"2912", name:"統一超" },
  { id:"1101", name:"台泥" },
  { id:"1102", name:"亞泥" },
  { id:"1301", name:"台塑" },
  { id:"1303", name:"南亞" },
  { id:"6505", name:"台塑化" },
  { id:"2207", name:"和泰車" },
  { id:"2105", name:"正新" },
  { id:"2603", name:"長榮" },
  { id:"2609", name:"陽明" },
  { id:"2615", name:"萬海" },
  { id:"0050", name:"元大台灣50" },
  { id:"0056", name:"元大高股息" },
  { id:"006208", name:"富邦台50" },
  { id:"00878", name:"國泰永續高股息" },
  { id:"other", name:"其他／自訂" }
];

function stockLabel(s){ return `${s.id} ${s.name}`; }

function renderStockOptions(keyword=""){
  const sel = document.getElementById("inv-stock");
  if(!sel) return;
  const kw = String(keyword || "").trim();

  const list = STOCK_UNIVERSE.filter(s=>{
    if (!kw) return true;
    return s.id.includes(kw) || s.name.includes(kw);
  });

  sel.innerHTML = "";
  list.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = stockLabel(s);
    sel.appendChild(opt);
  });

  if (sel.options.length) sel.value = sel.options[0].value;
  handleStockCustomInput();
}

function handleStockCustomInput(){
  const sel = document.getElementById("inv-stock");
  const custom = document.getElementById("inv-stock-custom");
  if(!sel || !custom) return;
  const isOther = sel.value === "other";
  custom.disabled = !isOther;
  if (!isOther) custom.value = "";
}

(function initStockPicker(){
  const search = document.getElementById("inv-stock-search");
  const sel = document.getElementById("inv-stock");
  if(!search || !sel) return;

  renderStockOptions("");
  search.addEventListener("input", ()=> renderStockOptions(search.value));
  sel.addEventListener("change", ()=>{
    handleStockCustomInput();
    // 切股票時，若本機有保存股利資料就自動帶出
    tryAutoFillDividendFromLocal();
  });
  handleStockCustomInput();
})();



/* ========================= 股利政策（Goodinfo 代理爬蟲 API）========================= */
const LS_DIVDB = "finance_game_dividend_db_v1";
const DEFAULT_PROXY_BASE = "http://localhost:8787"; // 你也可以改成你部署後的網址

function getSelectedStockId(){
  const sel = document.getElementById("inv-stock");
  if(!sel) return "";
  const v = sel.value;
  if (v === "other"){
    return String(document.getElementById("inv-stock-custom")?.value || "").trim();
  }
  return String(v || "").trim();
}

function loadDivDB(){
  try{ return JSON.parse(localStorage.getItem(LS_DIVDB) || "{}"); }catch(e){ return {}; }
}
function saveDivDB(db){
  localStorage.setItem(LS_DIVDB, JSON.stringify(db));
}

function showDivAlert(msg, type="danger"){ showAlert("div-alert", msg, type); }
function hideDivAlert(){ hideAlert("div-alert"); }

function renderYearOptions(years, selected){
  const sel = document.getElementById("div-year");
  if(!sel) return;
  sel.innerHTML = "";
  (years || []).forEach(y=>{
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    sel.appendChild(opt);
  });
  if (selected) sel.value = String(selected);
}

function setDividendInputs(item){
  if(!item) return;
  const ySel = document.getElementById("div-year");
  if(ySel && item.year) ySel.value = String(item.year);
  const a = document.getElementById("div-stock");
  const b = document.getElementById("div-cash");
  const c = document.getElementById("div-avgprice");
  if(a) a.value = (item.stock_div ?? "");
  if(b) b.value = (item.cash_div ?? "");
  if(c) c.value = (item.avg_price ?? "");
}

function tryAutoFillDividendFromLocal(){
  const stockId = getSelectedStockId();
  if(!stockId) return;
  const db = loadDivDB();
  const arr = db[stockId];
  if(Array.isArray(arr) && arr.length){
    renderYearOptions(arr.map(x=>x.year), arr[0].year);
    setDividendInputs(arr[0]);
  }
}

document.addEventListener("change", (e)=>{
  if(e?.target?.id === "div-year"){
    const stockId = getSelectedStockId();
    const year = parseInt(document.getElementById("div-year").value, 10);
    const db = loadDivDB();
    const arr = db[stockId];
    const item = Array.isArray(arr) ? arr.find(x=>Number(x.year)===Number(year)) : null;
    if(item) setDividendInputs(item);
  }
});

async function fetchDividendFromProxy(){
  hideDivAlert();
  const stockId = getSelectedStockId();
  if (!stockId){ showDivAlert("請先選擇或輸入股票代號。"); return; }

  try{
    const url = `${DEFAULT_PROXY_BASE}/api/dividend?stock_id=${encodeURIComponent(stockId)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data.items || !data.items.length){
      showDivAlert("抓到的資料是空的（可能被擋或解析不到表格）。"); return;
    }

    const latest = data.items[0];
    renderYearOptions(data.items.map(x=>x.year), latest.year);
    setDividendInputs(latest);

    const db = loadDivDB();
    db[stockId] = data.items;
    saveDivDB(db);

    showDivAlert("已從代理 API 更新並保存到本機。", "success");
  }catch(err){
    showDivAlert("更新失敗：請確認你已啟動 goodinfo-proxy（http://localhost:8787），或 Goodinfo 暫時擋爬。你也可以先用「手動保存」。");
  }
}

function saveDividendManual(){
  hideDivAlert();
  const stockId = getSelectedStockId();
  if (!stockId){ showDivAlert("請先選擇或輸入股票代號。"); return; }

  const year = parseInt(document.getElementById("div-year")?.value, 10) || new Date().getFullYear();
  const item = {
    year,
    stock_div: parseFloat(document.getElementById("div-stock")?.value) || 0,
    cash_div: parseFloat(document.getElementById("div-cash")?.value) || 0,
    avg_price: parseFloat(document.getElementById("div-avgprice")?.value) || 0
  };

  const db = loadDivDB();
  const arr = Array.isArray(db[stockId]) ? db[stockId] : [];
  const next = [item].concat(arr.filter(x=>Number(x.year)!==year));
  next.sort((a,b)=>Number(b.year)-Number(a.year));
  db[stockId] = next;
  saveDivDB(db);

  renderYearOptions(next.map(x=>x.year), year);
  showDivAlert("已手動保存到瀏覽器。", "success");
}

function applyDividendToInvestModeB(){
  hideDivAlert();
  const avg = parseFloat(document.getElementById("div-avgprice")?.value);
  const cash = parseFloat(document.getElementById("div-cash")?.value);
  if (!avg || avg <= 0){ showDivAlert("年均價需大於 0 才能套用。"); return; }

  const startPrice = document.getElementById("inv-start-price");
  const divy = document.getElementById("inv-divy");
  if(startPrice) startPrice.value = avg;

  const dy = cash > 0 ? (cash / avg) : 0;
  if(divy) divy.value = String(dy.toFixed(4));

  showDivAlert("已套用到模式 B（起始股價＋第一年殖利率）。", "success");
}

function exportDividendDB(){
  const db = loadDivDB();
  const text = JSON.stringify(db, null, 2);
  downloadText(text, "dividend_db.json", "application/json");
}


e-body");
    tbody.innerHTML = "";

    for (let i=1;i<=n;i++){
      const interest = balance * r;
      let principalPay = payment - interest;

      if (i === n){
        principalPay = balance;
        payment = principalPay + interest;
      }

      balance = balance - principalPay;
      if (balance < 1e-8) balance = 0;

      totalInterest += interest;

      const tr = document.createElement("tr");
      [i, formatMoney(payment), formatMoney(principalPay), formatMoney(interest), formatMoney(balance)]
        .forEach(v=>{
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        });
      tbody.appendChild(tr);
    }

    const totalPaid = principal + totalInterest;
    document.getElementById("loan-payment").textContent = formatMoney(payment);
    document.getElementById("loan-total-interest").textContent = formatMoney(totalInterest);
    document.getElementById("loan-total-paid").textContent = formatMoney(totalPaid);
    showAlert("loan-alert","已完成計算。","success");
  }

  function clearLoan(){
    document.getElementById("loan-table-body").innerHTML = "";
    document.getElementById("loan-payment").textContent = "-";
    document.getElementById("loan-total-interest").textContent = "-";
    document.getElementById("loan-total-paid").textContent = "-";
    hideAlert("loan-alert");
  }
</script>
</body>
</html>
