<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>金融程式整合小遊戲</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f7fb;
      color: #222;
    }
    header {
      background: #1d4ed8;
      color: white;
      padding: 16px 24px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.8;
    }
    .container {
      max-width: 1080px;
      margin: 16px auto 32px;
      padding: 0 16px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      background: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
    }
    .tab-btn.active {
      background: #1d4ed8;
      color: white;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }
    h2 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #111827;
    }
    h3 {
      margin: 16px 0 8px;
      font-size: 15px;
      color: #111827;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, textarea, select {
      font-family: inherit;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .col-3 { flex: 1 1 150px; }
    .col-4 { flex: 1 1 200px; }
    .btn {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #1d4ed8;
      color: white;
      cursor: pointer;
      font-size: 13px;
      margin-top: 4px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 11px;
      margin-left: 4px;
    }
    .stat-line {
      font-size: 13px;
      margin: 2px 0;
    }
    .stat-line span.value {
      font-weight: 600;
      color: #111827;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    td:first-child, th:first-child {
      text-align: left;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 11px;
      margin-right: 4px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .small {
      font-size: 11px;
      color: #6b7280;
    }
  </style>
</head>
<body>
<header>
  <h1>金融程式整合小遊戲</h1>
  <p>把 Excel 的「股利投資」、「收支事件」、「保險＋貸款」合在同一個網頁</p>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" data-target="module-invest">股利／報酬投資模擬</button>
    <button class="tab-btn" data-target="module-budget">收支配置＋事件遊戲</button>
    <button class="tab-btn" data-target="module-insurance">保險小遊戲＋貸款試算</button>
  </div>

  <!-- 模組一：股利／報酬投資模擬（對應 金融統計.xlsm） -->
  <section id="module-invest" class="section active">
    <div class="card">
      <h2>股利／報酬投資模擬</h2>
      <p class="small">
        對應你「金融統計」檔案裡的 <b>計算</b> 工作表：輸入股票、投資方式、期間，算出最終財富、累積報酬率、年化報酬率。  
        這裡用「年報酬率序列」來取代原本 Excel 裡的股利＋股價計算，方便你之後自行貼上歷史資料。
      </p>

      <div class="row">
        <div class="col-3">
          <label>投資股票代號（純顯示，可依需求擴充）</label>
          <select id="inv-stock">
            <option value="2603">2603</option>
            <option value="2357">2357</option>
            <option value="2207">2207</option>
            <option value="2727">2727</option>
            <option value="other" selected>其他／自訂</option>
          </select>
        </div>
        <div class="col-3">
          <label>投資期間（年）</label>
          <input id="inv-years" type="number" min="1" value="10">
        </div>
        <div class="col-3">
          <label>年報酬率序列（小數，逗號分隔）<span class="pill">例如：0.08,0.05,-0.02,...</span></label>
          <textarea id="inv-returns">0.08,0.05,0.03,-0.02,0.1</textarea>
        </div>
      </div>

      <h3>投資方式</h3>
      <div class="row">
        <div class="col-3">
          <label><input type="radio" name="inv-mode" value="lumpsum" checked> 一次性投入</label>
          <input id="inv-lumpsum" type="number" min="0" value="100000" placeholder="一次投入金額">
        </div>
        <div class="col-3">
          <label><input type="radio" name="inv-mode" value="annual"> 每年固定金額</label>
          <input id="inv-annual" type="number" min="0" value="10000" placeholder="每年投入金額">
        </div>
      </div>

      <button class="btn" onclick="runInvestment()">計算投資結果</button>

      <h3>計算結果</h3>
      <div id="inv-output">
        <p class="stat-line">投入成本：<span class="value" id="inv-total-invest">-</span></p>
        <p class="stat-line">最終財富：<span class="value" id="inv-final-wealth">-</span></p>
        <p class="stat-line">累積報酬率：<span class="value" id="inv-total-return">-</span></p>
        <p class="stat-line">年化報酬率（幾何平均）：<span class="value" id="inv-annual-return">-</span></p>
      </div>
    </div>
  </section>

  <!-- 模組二：收支配置＋事件遊戲（對應 活頁簿5.xlsm） -->
  <section id="module-budget" class="section">
    <div class="card">
      <h2>收支配置＋生活事件小遊戲</h2>
      <p class="small">
        對應「活頁簿5」裡的 GameBoard / GameSheet / 工作表1：  
        先設定每月收入與各項百分比，然後每一回合隨機觸發事件（洗衣機壞掉、中樂透等等），看現金餘額怎麼變化。
      </p>

      <h3>基本設定</h3>
      <div class="row">
        <div class="col-3">
          <label>每月收入（元）</label>
          <input id="budget-income" type="number" min="0" value="65000">
        </div>
        <div class="col-3">
          <label>民生必需品投入 %</label>
          <input id="pct-necessities" type="number" min="0" max="100" value="30">
        </div>
        <div class="col-3">
          <label>緊急預備金投入 %</label>
          <input id="pct-emergency" type="number" min="0" max="100" value="20">
        </div>
        <div class="col-3">
          <label>娛樂支出投入 %</label>
          <input id="pct-entertainment" type="number" min="0" max="100" value="10">
        </div>
        <div class="col-3">
          <label>投資可用餘裕投入 %</label>
          <input id="pct-invest" type="number" min="0" max="100" value="20">
        </div>
      </div>
      <p class="small">剩下的比例自動視為「其他支出／儲蓄」。你可以照你 Excel 的公式再微調。</p>

      <button class="btn" id="budget-start-btn" onclick="startBudgetGame()">開始新遊戲</button>
      <button class="btn" id="budget-next-btn" onclick="nextBudgetTurn()" disabled>下一回合（擲骰＋事件）</button>

      <h3>目前狀態</h3>
      <p class="stat-line">回合數：<span class="value" id="budget-turn">-</span></p>
      <p class="stat-line">現金餘額：<span class="value" id="budget-cash">-</span></p>

      <h3>事件紀錄</h3>
      <table>
        <thead>
          <tr>
            <th>回合</th>
            <th>骰子點數</th>
            <th>事件</th>
            <th>金額變動</th>
            <th>說明</th>
            <th>結束後現金</th>
          </tr>
        </thead>
        <tbody id="budget-log-body"></tbody>
      </table>
    </div>
  </section>

  <!-- 模組三：保險小遊戲＋貸款試算（對應 第一組金融程式應用.xlsm） -->
  <section id="module-insurance" class="section">
    <div class="card">
      <h2>保險小遊戲（保費 vs. 理賠）</h2>
      <p class="small">
        對應「Dashboard / Params / State / Log」：用簡化版規則比較有買／沒買保險時，長期現金流的差異。
        參數預設值取自 Params 工作表，可以直接改。
      </p>

      <h3>參數設定</h3>
      <div class="row">
        <div class="col-3">
          <label>起始現金 StartCash</label>
          <input id="ins-start-cash" type="number" value="120000">
        </div>
        <div class="col-3">
          <label>起始年齡 StartAge</label>
          <input id="ins-start-age" type="number" value="24">
        </div>
        <div class="col-3">
          <label>總回合 MaxTurns</label>
          <input id="ins-max-turns" type="number" value="15">
        </div>
      </div>

      <div class="row">
        <div class="col-3">
          <h3>保費 Prem</h3>
          <label>壽險 Prem_Life</label>
          <input id="ins-prem-life" type="number" value="6000">
          <label>醫療 Prem_Medical</label>
          <input id="ins-prem-medical" type="number" value="4500">
          <label>財產 Prem_Property</label>
          <input id="ins-prem-property" type="number" value="3000">
        </div>
        <div class="col-3">
          <h3>事故機率 Prob</h3>
          <label>壽險 Prob_Life</label>
          <input id="ins-prob-life" type="number" step="0.01" value="0.01">
          <label>醫療 Prob_Medical</label>
          <input id="ins-prob-medical" type="number" step="0.01" value="0.12">
          <label>財產 Prob_Property</label>
          <input id="ins-prob-property" type="number" step="0.01" value="0.06">
        </div>
        <div class="col-3">
          <h3>理賠金額 Payout</h3>
          <label>壽險 Payout_Life</label>
          <input id="ins-payout-life" type="number" value="500000">
          <label>醫療 Payout_Medical</label>
          <input id="ins-payout-medical" type="number" value="50000">
          <label>財產 Payout_Property</label>
          <input id="ins-payout-property" type="number" value="120000">
        </div>
        <div class="col-3">
          <h3>保險選擇</h3>
          <label><input type="checkbox" id="ins-has-life" checked> 投保壽險</label>
          <label><input type="checkbox" id="ins-has-medical" checked> 投保醫療險</label>
          <label><input type="checkbox" id="ins-has-property" checked> 投保財產險</label>
          <p class="small">（這裡先假設「有保」就只付保費、事故發生就拿理賠，不另外計入自付額。若要完全跟 Excel 一樣，可再依 CostNoIns_* 等欄位調整。）</p>
        </div>
      </div>

      <button class="btn" onclick="startInsGame()">開始新遊戲</button>
      <button class="btn" id="ins-next-btn" onclick="nextInsTurn()" disabled>下一回合</button>

      <h3>目前狀態</h3>
      <p class="stat-line">年齡：<span class="value" id="ins-age">-</span></p>
      <p class="stat-line">回合：<span class="value" id="ins-turn">-</span></p>
      <p class="stat-line">現金餘額：<span class="value" id="ins-cash">-</span></p>
      <p class="stat-line">累積保費：<span class="value" id="ins-total-prem">-</span></p>
      <p class="stat-line">累積理賠：<span class="value" id="ins-total-payout">-</span></p>

      <h3>事件紀錄</h3>
      <table>
        <thead>
          <tr>
            <th>回合</th>
            <th>年齡</th>
            <th>保費支出</th>
            <th>理賠收入</th>
            <th>事故說明</th>
            <th>回合後現金</th>
          </tr>
        </thead>
        <tbody id="ins-log-body"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>貸款攤還表試算</h2>
      <p class="small">
        對應「貸款計算」工作表：輸入本金、年利率、年限與每年付款次數，算出每期付款金額與攤還表。
      </p>

      <div class="row">
        <div class="col-4">
          <label>貸款本金</label>
          <input id="loan-principal" type="number" value="500000">
        </div>
        <div class="col-4">
          <label>貸款年利率（%）</label>
          <input id="loan-rate" type="number" step="0.01" value="2">
        </div>
        <div class="col-4">
          <label>貸款年限（年）</label>
          <input id="loan-years" type="number" value="15">
        </div>
        <div class="col-4">
          <label>每年付款次數</label>
          <input id="loan-nperyear" type="number" value="6">
        </div>
      </div>

      <button class="btn" onclick="calcLoan()">計算攤還表</button>

      <h3>結果摘要</h3>
      <p class="stat-line">每期應付金額：<span class="value" id="loan-payment">-</span></p>
      <p class="stat-line">總支付利息：<span class="value" id="loan-total-interest">-</span></p>
      <p class="stat-line">總還款金額：<span class="value" id="loan-total-paid">-</span></p>

      <h3>攤還明細</h3>
      <table>
        <thead>
          <tr>
            <th>期數</th>
            <th>每期付款</th>
            <th>本金</th>
            <th>利息</th>
            <th>剩餘本金</th>
          </tr>
        </thead>
        <tbody id="loan-table-body"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  // —— 共用：Tab 切換 ——
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.target).classList.add('active');
    });
  });

  function formatMoney(num) {
    if (isNaN(num)) return '-';
    return num.toLocaleString('zh-TW', { maximumFractionDigits: 2 });
  }
  function parseNumber(id) {
    const v = parseFloat(document.getElementById(id).value);
    return isNaN(v) ? 0 : v;
  }

  // ===== 模組一：投資模擬 =====
  function runInvestment() {
    const years = parseInt(document.getElementById('inv-years').value, 10) || 0;
    if (years <= 0) {
      alert('投資期間請輸入正整數年。');
      return;
    }
    const returnsText = document.getElementById('inv-returns').value;
    const returns = returnsText.split(',').map(s => parseFloat(s.trim())).filter(v => !isNaN(v));
    if (returns.length === 0) {
      alert('請至少輸入一個年報酬率。');
      return;
    }

    const mode = document.querySelector('input[name="inv-mode"]:checked').value;
    let totalInvest = 0;
    let wealth = 0;

    if (mode === 'lumpsum') {
      const lump = parseNumber('inv-lumpsum');
      if (lump <= 0) {
        alert('請輸入一次投入金額。');
        return;
      }
      totalInvest = lump;
      wealth = lump;
      for (let i = 0; i < years; i++) {
        const r = returns[Math.min(i, returns.length - 1)];
        wealth = wealth * (1 + r);
      }
    } else {
      const annual = parseNumber('inv-annual');
      if (annual <= 0) {
        alert('請輸入每年投入金額。');
        return;
      }
      totalInvest = 0;
      wealth = 0;
      for (let i = 0; i < years; i++) {
        const r = returns[Math.min(i, returns.length - 1)];
        wealth = (wealth + annual) * (1 + r);
        totalInvest += annual;
      }
    }

    const totalReturn = wealth / totalInvest - 1;
    const annualReturn = Math.pow(1 + totalReturn, 1 / years) - 1;

    document.getElementById('inv-total-invest').textContent = formatMoney(totalInvest);
    document.getElementById('inv-final-wealth').textContent = formatMoney(wealth);
    document.getElementById('inv-total-return').textContent = (totalReturn * 100).toFixed(2) + '%';
    document.getElementById('inv-annual-return').textContent = (annualReturn * 100).toFixed(2) + '%';
  }

  // ===== 模組二：收支＋事件遊戲 =====
  const budgetEvents = [
    { name: '家中洗衣機壞掉', delta: -8000, desc: '必需品開支增加，得換新洗衣機。' },
    { name: '通貨膨脹情境', delta: -3000, desc: '物價上漲，生活成本提高。' },
    { name: '中樂透', delta: 100000, desc: '太爽了！一次性大量收入。' },
    { name: '公司尾牙抽中十萬', delta: 100000, desc: '公司尾牙抽獎中的獎金。' },
    { name: '突發車禍賠款', delta: -50000, desc: '車禍需要賠償與修車費用。' },
    { name: '教育費加收人事費用', delta: -10000, desc: '學校臨時加收費用。' },
    { name: '水電費加收', delta: -3000, desc: '水電費用突然增加。' },
    { name: '醫療保健支出增加', delta: -8000, desc: '家人身體不適，需要額外醫療支出。' },
    { name: '股票小漲', delta: 5000, desc: '投資部位小幅獲利。' },
    { name: '股票小跌', delta: -5000, desc: '投資部位小幅虧損。' },
    { name: '朋友借款還你', delta: 10000, desc: '之前借出去的錢終於回來了。' },
    { name: '意外損失', delta: -6000, desc: '生活中突發的小意外開銷。' },
    { name: '獎金入帳', delta: 20000, desc: '工作表現良好，獲得獎金。' },
    { name: '旅行意外花費', delta: -13000, desc: '旅遊中花費超出預期。' }
  ];

  let budgetState = null;

  function startBudgetGame() {
    const income = parseNumber('budget-income');
    if (income <= 0) {
      alert('請輸入每月收入（>0）。');
      return;
    }
    const pNec = parseNumber('pct-necessities');
    const pEmg = parseNumber('pct-emergency');
    const pEnt = parseNumber('pct-entertainment');
    const pInv = parseNumber('pct-invest');
    const sumP = pNec + pEmg + pEnt + pInv;

    if (sumP > 100) {
      alert('各項投入百分比總和不可超過 100%。');
      return;
    }

    budgetState = {
      turn: 0,
      cash: income, // 初始現金先用一個月收入當基準
      income: income,
      percents: { necessities: pNec, emergency: pEmg, entertainment: pEnt, invest: pInv }
    };

    document.getElementById('budget-turn').textContent = '0';
    document.getElementById('budget-cash').textContent = formatMoney(budgetState.cash);
    document.getElementById('budget-log-body').innerHTML = '';

    document.getElementById('budget-start-btn').textContent = '重新開始';
    document.getElementById('budget-next-btn').disabled = false;
  }

  function nextBudgetTurn() {
    if (!budgetState) {
      alert('請先按「開始新遊戲」。');
      return;
    }
    const roll = Math.floor(Math.random() * 6) + 1;
    const event = budgetEvents[Math.floor(Math.random() * budgetEvents.length)];
    budgetState.turn += 1;
    budgetState.cash += event.delta;

    document.getElementById('budget-turn').textContent = String(budgetState.turn);
    document.getElementById('budget-cash').textContent = formatMoney(budgetState.cash);

    const tr = document.createElement('tr');
    const cells = [
      budgetState.turn,
      roll,
      event.name,
      (event.delta >= 0 ? '+' : '') + formatMoney(event.delta),
      event.desc,
      formatMoney(budgetState.cash)
    ];
    cells.forEach((v, idx) => {
      const td = document.createElement('td');
      td.textContent = v;
      if (idx === 3 && event.delta < 0) td.style.color = '#b91c1c';
      if (idx === 3 && event.delta > 0) td.style.color = '#047857';
      tr.appendChild(td);
    });
    document.getElementById('budget-log-body').appendChild(tr);
  }

  // ===== 模組三：保險小遊戲 =====
  let insState = null;

  function startInsGame() {
    const cash = parseNumber('ins-start-cash');
    const age = parseInt(document.getElementById('ins-start-age').value, 10) || 0;
    const maxTurns = parseInt(document.getElementById('ins-max-turns').value, 10) || 0;
    if (cash <= 0 || age <= 0 || maxTurns <= 0) {
      alert('請確認起始現金、年齡與回合數皆為正數。');
      return;
    }

    insState = {
      age: age,
      turn: 0,
      maxTurns: maxTurns,
      cash: cash,
      totalPrem: 0,
      totalPayout: 0
    };

    document.getElementById('ins-age').textContent = insState.age;
    document.getElementById('ins-turn').textContent = insState.turn;
    document.getElementById('ins-cash').textContent = formatMoney(insState.cash);
    document.getElementById('ins-total-prem').textContent = formatMoney(0);
    document.getElementById('ins-total-payout').textContent = formatMoney(0);
    document.getElementById('ins-log-body').innerHTML = '';
    document.getElementById('ins-next-btn').disabled = false;
  }

  function nextInsTurn() {
    if (!insState) {
      alert('請先按「開始新遊戲」。');
      return;
    }
    if (insState.turn >= insState.maxTurns) {
      alert('已經到達最大回合數。');
      document.getElementById('ins-next-btn').disabled = true;
      return;
    }

    const premLife = parseNumber('ins-prem-life');
    const premMed = parseNumber('ins-prem-medical');
    const premProp = parseNumber('ins-prem-property');
    const probLife = parseFloat(document.getElementById('ins-prob-life').value) || 0;
    const probMed = parseFloat(document.getElementById('ins-prob-medical').value) || 0;
    const probProp = parseFloat(document.getElementById('ins-prob-property').value) || 0;
    const payoutLife = parseNumber('ins-payout-life');
    const payoutMed = parseNumber('ins-payout-medical');
    const payoutProp = parseNumber('ins-payout-property');

    const hasLife = document.getElementById('ins-has-life').checked;
    const hasMed = document.getElementById('ins-has-medical').checked;
    const hasProp = document.getElementById('ins-has-property').checked;

    insState.turn += 1;
    insState.age += 1;

    let premThisTurn = 0;
    let payoutThisTurn = 0;
    let descs = [];

    if (hasLife) premThisTurn += premLife;
    if (hasMed) premThisTurn += premMed;
    if (hasProp) premThisTurn += premProp;

    insState.cash -= premThisTurn;
    insState.totalPrem += premThisTurn;

    if (hasLife && Math.random() < probLife) {
      payoutThisTurn += payoutLife;
      descs.push('發生壽險事故，理賠 ' + formatMoney(payoutLife));
    }
    if (hasMed && Math.random() < probMed) {
      payoutThisTurn += payoutMed;
      descs.push('發生醫療事故，理賠 ' + formatMoney(payoutMed));
    }
    if (hasProp && Math.random() < probProp) {
      payoutThisTurn += payoutProp;
      descs.push('發生財產事故，理賠 ' + formatMoney(payoutProp));
    }

    if (payoutThisTurn === 0) {
      descs.push('本回合無事故發生');
    }

    insState.cash += payoutThisTurn;
    insState.totalPayout += payoutThisTurn;

    document.getElementById('ins-age').textContent = insState.age;
    document.getElementById('ins-turn').textContent = insState.turn;
    document.getElementById('ins-cash').textContent = formatMoney(insState.cash);
    document.getElementById('ins-total-prem').textContent = formatMoney(insState.totalPrem);
    document.getElementById('ins-total-payout').textContent = formatMoney(insState.totalPayout);

    const tr = document.createElement('tr');
    const cells = [
      insState.turn,
      insState.age,
      '-' + formatMoney(premThisTurn),
      '+' + formatMoney(payoutThisTurn),
      descs.join('；'),
      formatMoney(insState.cash)
    ];
    cells.forEach((v, idx) => {
      const td = document.createElement('td');
      td.textContent = v;
      if (idx === 2 && premThisTurn > 0) td.style.color = '#b91c1c';
      if (idx === 3 && payoutThisTurn > 0) td.style.color = '#047857';
      tr.appendChild(td);
    });
    document.getElementById('ins-log-body').appendChild(tr);

    if (insState.turn >= insState.maxTurns) {
      document.getElementById('ins-next-btn').disabled = true;
    }
  }

  // ===== 模組三：貸款攤還表 =====
  function calcLoan() {
    const principal = parseNumber('loan-principal');
    const rateAnnual = parseFloat(document.getElementById('loan-rate').value) / 100;
    const years = parseInt(document.getElementById('loan-years').value, 10) || 0;
    const nperYear = parseInt(document.getElementById('loan-nperyear').value, 10) || 0;

    if (principal <= 0 || rateAnnual <= 0 || years <= 0 || nperYear <= 0) {
      alert('請確認本金、利率、年限與每年付款次數皆為正數。');
      return;
    }

    const r = rateAnnual / nperYear;
    const n = years * nperYear;
    const payment = principal * r / (1 - Math.pow(1 + r, -n));

    let balance = principal;
    let totalInterest = 0;
    const tbody = document.getElementById('loan-table-body');
    tbody.innerHTML = '';

    for (let i = 1; i <= n; i++) {
      const interest = balance * r;
      let principalPay = payment - interest;
      if (i === n) { // 最後一期補差
        principalPay = balance;
      }
      balance -= principalPay;
      totalInterest += interest;

      const tr = document.createElement('tr');
      const cells = [
        i,
        formatMoney(payment),
        formatMoney(principalPay),
        formatMoney(interest),
        formatMoney(Math.max(balance, 0))
      ];
      cells.forEach((v, idx) => {
        const td = document.createElement('td');
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    const totalPaid = principal + totalInterest;
    document.getElementById('loan-payment').textContent = formatMoney(payment);
    document.getElementById('loan-total-interest').textContent = formatMoney(totalInterest);
    document.getElementById('loan-total-paid').textContent = formatMoney(totalPaid);
  }
</script>
</body>
</html>
